<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>BZTracker</title>
  <!-- Load Chart.js (as in your original code) -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js" defer></script>
  <style>
    /***********************************************
     *               THEME VARIABLES
     ***********************************************/
    :root {
      --transition-speed: 0.3s;
      --font-family: "Roboto", sans-serif;
    }

    /* === Dark Theme (‚ÄúCrying Obsidian‚Äù) === */
    body.dark-theme {
      --bg-color: #0b0c10;         
      --sidebar-bg: #151528;       
      --accent-color: #8a2be2;     
      --text-color: #e6e6fa;       
      --card-bg: #1d1d2b;         
      --particle-color: rgba(138,43,226, 0.5); 
    }

    /* === Light Theme (‚ÄúIce‚Äù) === */
    body.light-theme {
      --bg-color: #f6fafd;        
      --sidebar-bg: #eaf2f8;      
      --accent-color: #3eb4f0;    
      --text-color: #1a1a1a;      
      --card-bg: #ffffff;         
      --particle-color: rgba(62,180,240, 0.5); 
    }

    /***********************************************
     *            GLOBAL / BASE STYLES
     ***********************************************/
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    html {
      scroll-behavior: smooth;
    }
    body {
      font-family: var(--font-family);
      background-color: var(--bg-color);
      color: var(--text-color);
      margin: 0;
      transition: background-color var(--transition-speed), color var(--transition-speed);
      overflow-x: hidden;
      position: relative; 
    }

    /* Particle container for the background canvas */
    #particle-container {
      position: fixed;
      top: 0; 
      left: 0;
      width: 100%; 
      height: 100%;
      pointer-events: none;
      z-index: 0;
      overflow: hidden;
    }

    /***********************************************
     *  SIDEBAR & MENU / SOUND TOGGLES
     ***********************************************/
    #menuToggle, #soundToggle {
      position: fixed;
      top: 15px;
      background: none;
      color: var(--accent-color);
      border: 2px solid var(--accent-color);
      padding: 8px 12px;
      font-size: 18px;
      border-radius: 4px;
      cursor: pointer;
      z-index: 1001; 
      transition: background var(--transition-speed), color var(--transition-speed);
    }
    #menuToggle:hover, #soundToggle:hover {
      background: var(--accent-color);
      color: #fff;
      text-shadow: 0 0 5px var(--accent-color);
    }
    #menuToggle {
      left: 15px;
    }
    #soundToggle {
      right: 15px;
    }

    #sidebar {
      position: fixed;
      top: 0; left: 0;
      width: 240px;
      height: 100%;
      background: var(--sidebar-bg);
      padding: 60px 20px;
      transform: translateX(-260px); 
      transition: transform var(--transition-speed) ease;
      z-index: 1002; 
      box-shadow: 5px 0 10px rgba(0, 0, 0, 0.4);
    }
    #sidebar.open {
      transform: translateX(0);
    }
    #sidebar h1 {
      margin: 0 0 30px 0;
      color: var(--accent-color);
      text-align: center;
    }
    #sidebar ul {
      list-style: none;
      margin: 0; 
      padding: 0;
    }
    #sidebar li {
      margin: 15px 0;
    }
    #sidebar a {
      color: var(--text-color);
      font-size: 1rem;
      display: block;
      transition: background var(--transition-speed), text-shadow var(--transition-speed);
      padding: 8px 5px;
      border-radius: 4px;
      text-decoration: none;
    }
    #sidebar a:hover {
      background: rgba(138, 43, 226, 0.2); 
      text-shadow: 0 0 5px var(--accent-color);
    }
    #overlay {
      position: fixed;
      top: 0; left: 0;
      width: 100%; 
      height: 100%;
      background: rgba(0,0,0,0.5);
      display: none;
      z-index: 1001;
    }
    #overlay.show {
      display: block;
    }

    /***********************************************
     *   MAIN CONTENT & SECTION BACKGROUNDS
     ***********************************************/
    #mainContent {
      max-width: 1200px;
      margin: 0 auto;
      padding: 70px 20px 40px;
      position: relative;
      z-index: 10; 
    }

    /*
      The next two blocks provide the distinct looks for each theme‚Äôs sections:
      - Dark theme: cracked crying obsidian texture + neon glow
      - Light theme: ice texture overlay
      Just replace the URLs with your own textures or images if you like.
    */
    body.dark-theme section {
      /* 
         Example: a ‚Äúcracked Crying Obsidian‚Äù background plus a neon glow around each section.
         Replace crying_obsidian.png with your actual image. 
      */
      background: 
        url("assets/crying_obsidian.png") /* placeholder image path */
        no-repeat center/cover,
        var(--card-bg);
      box-shadow: 0 0 12px var(--accent-color);
      border: 2px solid rgba(138,43,226,0.3);
    }

    body.light-theme section {
      /*
         Example: an ice texture overlay for the background
         Replace ice_texture.png with your actual image.
      */
      background:
        url("assets/ice_texture.png") /* placeholder image path */
        no-repeat center/cover,
        var(--card-bg);
      box-shadow: 0 0 12px rgba(62,180,240, 0.3);
      border: 2px solid rgba(62,180,240,0.3);
    }

    section h2 {
      text-align: center;
      margin-bottom: 20px;
      text-transform: uppercase;
    }

    /***********************************************
     *   LOADER (SPINNER)
     ***********************************************/
    #loader {
      display: none;
      margin: 10px 0;
      text-align: center;
    }
    .spinner {
      border: 6px solid #999;
      border-top: 6px solid var(--accent-color);
      border-radius: 50%;
      width: 35px; 
      height: 35px;
      animation: spin 1s linear infinite;
      margin: 0 auto;
    }
    @keyframes spin {
      100% { transform: rotate(360deg); }
    }

    /***********************************************
     *         SEARCH SECTION
     ***********************************************/
    #search-form {
      display: flex;
      flex-direction: column;
      gap: 10px;
      margin-bottom: 10px;
    }
    #search-form input {
      padding: 15px;
      background: #222;
      border: 2px solid #333;
      border-radius: 5px;
      color: #fff;
      font-size: 1rem;
    }
    #search-form input::placeholder {
      color: #777;
    }
    #search-form button {
      align-self: start;
    }
    #suggestions {
      position: relative;
    }
    #suggestions div {
      background: #2f2f46;
      padding: 10px;
      border: 1px solid var(--accent-color);
      cursor: pointer;
      transition: background var(--transition-speed);
      margin-bottom: 2px;
    }
    #suggestions div:hover {
      background: #3c3c60;
    }
    #result p {
      margin: 5px 0;
    }

    /***********************************************
     *         GRAPH SECTION
     ***********************************************/
    .time-range-btn {
      margin: 0 5px;
      padding: 5px 10px;
      background: #333;
      color: #fff;
      border-radius: 5px;
      transition: background var(--transition-speed), box-shadow var(--transition-speed);
    }
    .time-range-btn:hover {
      background: var(--accent-color);
      color: #fff;
      box-shadow: 0 0 8px var(--accent-color);
    }
    #priceGraph {
      background: #1a1a1a;
      border-radius: 10px;
      display: block;
      width: 100%;
      height: auto;
      margin-bottom: 15px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.3);
    }

    /***********************************************
     *         TOP MARGINS & ITEMS
     ***********************************************/
    #top-margins-section select,
    #top-margins-section button {
      margin: 5px 5px 5px 0;
    }
    #top-margins {
      margin-top: 15px;
    }
    .item-card {
      background: #222;
      padding: 15px;
      border-radius: 10px;
      margin-bottom: 10px;
      transition: transform 0.3s ease, box-shadow 0.3s ease;
      box-shadow: 0 2px 5px rgba(0,0,0,0.3);
    }
    .item-card:hover {
      transform: scale(1.03);
      box-shadow: 0 0 10px var(--accent-color);
    }
    .item-card p {
      margin: 4px 0;
    }
    .item-card span {
      font-weight: bold;
      color: var(--accent-color);
    }

    /***********************************************
     *         PROFITABILITY SECTION
     ***********************************************/
    #profitability-section input {
      width: 80px;
      padding: 5px;
      margin: 0 10px 0 0;
      border: 2px solid #444;
      border-radius: 5px;
      background: #2f2f46;
      color: #fff;
    }

    /***********************************************
     *         TOP VARIATIONS SECTION
     ***********************************************/
    #top-variations-section select,
    #top-variations-section button {
      margin: 5px 5px 5px 0;
    }
    #top-variations {
      margin-top: 15px;
    }

    /***********************************************
     *         FLEX LAYOUTS
     ***********************************************/
    .flex-row {
      display: flex;
      gap: 20px;
      flex-wrap: wrap;
      justify-content: space-between;
    }
    .large { flex: 2; }
    .small { flex: 1; }

    /***********************************************
     *        SETTINGS SECTION (THEME TOGGLE)
     ***********************************************/
    #settings-section {
      display: flex;
      flex-direction: column;
      align-items: flex-start;
      gap: 10px;
    }
    #theme-toggle-container {
      display: flex;
      align-items: center;
      gap: 10px;
      margin: 10px 0;
    }
    #theme-select {
      padding: 5px 8px;
      border: 2px solid #444;
      background: #2f2f46;
      border-radius: 5px;
      color: #fff;
      cursor: pointer;
    }
    #theme-select option {
      color: #fff;
      background-color: #2f2f46;
    }

    /***********************************************
     *         RESPONSIVE
     ***********************************************/
    @media (max-width: 768px) {
      .flex-row { flex-direction: column; }
      .large, .small { flex: 1 1 100%; }
      #search-form button { align-self: stretch; }
    }
  </style>
</head>

<body class="dark-theme">
  <!-- Particle Container (Canvas for your scrolling, interactive particles) -->
  <div id="particle-container"></div>

  <!-- ===== SIDEBAR TOGGLE & SOUND TOGGLE ===== -->
  <button id="menuToggle">‚ò∞</button>
  <button id="soundToggle">üîá</button>

  <!-- ===== SIDEBAR ===== -->
  <div id="sidebar">
    <h1>BZTracker</h1>
    <ul>
      <li><a href="#search-section">Search</a></li>
      <li><a href="#graph-section">Price Graph</a></li>
      <li><a href="#top-margins-section">Top Margins</a></li>
      <li><a href="#profitability-section">Profitability</a></li>
      <li><a href="#top-variations-section">Top Variations</a></li>
      <li><a href="#settings-section">Settings</a></li>
    </ul>
  </div>
  <div id="overlay"></div>

  <!-- ===== MAIN CONTENT WRAPPER ===== -->
  <div id="mainContent">
    <!-- ====================== SEARCH SECTION ====================== -->
    <section id="search-section">
      <h2>Search</h2>
      <form id="search-form">
        <input type="text" id="item-search" placeholder="Search for an item..." autocomplete="off"/>
        <div id="suggestions"></div>
        <button type="submit">Search</button>
      </form>
      <div id="loader"><div class="spinner"></div></div>
      <div id="result"></div>
    </section>

    <!-- ====================== FLEX ROW FOR GRAPH & TOP MARGINS ====================== -->
    <div class="flex-row">
      <!-- ===== PRICE GRAPH SECTION ===== -->
      <section id="graph-section" class="large">
        <h2>Price Graph</h2>
        <canvas id="priceGraph"></canvas>
        <div class="flex-row" style="justify-content: center;">
          <button class="time-range-btn" data-range="1h">1 Hour</button>
          <button class="time-range-btn" data-range="24h">1 Day</button>
          <button class="time-range-btn" data-range="1w">1 Week</button>
          <button class="time-range-btn" data-range="1y">1 Year</button>
          <button class="time-range-btn" data-range="all">All Time</button>
        </div>
      </section>

      <!-- ===== TOP MARGINS SECTION ===== -->
      <section id="top-margins-section" class="small">
        <h2>Top 10 Items with Highest Margins</h2>
        <div>
          <label for="sort-by">Sort by:</label>
          <select id="sort-by">
            <option value="margin" selected>Margin</option>
            <option value="buy_price">Buy Price</option>
            <option value="sell_price">Sell Price</option>
            <option value="demand">Demand</option>
            <option value="supply">Supply</option>
          </select>

          <label for="order">Order:</label>
          <select id="order">
            <option value="desc" selected>Descending</option>
            <option value="asc">Ascending</option>
          </select>
          <button id="refresh-top-margins">Refresh</button>
        </div>
        <div id="top-margins"></div>
      </section>
    </div>

    <!-- ===== PROFITABILITY SECTION ===== -->
    <section id="profitability-section">
      <h2>Profitability (Coins Per Hour)</h2>
      <div style="margin-bottom:10px;">
        <label for="coins">Coins:</label>
        <input type="number" id="coins" value="0"/>
        <label for="difficulty">Difficulty:</label>
        <input type="number" id="difficulty" value="1" step="0.1"/>
        <button id="calculate-profit">Calculate Profit</button>
      </div>
      <div id="profitability-result"></div>
    </section>

    <!-- ===== TOP VARIATIONS SECTION ===== -->
    <section id="top-variations-section">
      <h2>Top 10 Items with Highest Price Variations</h2>
      <div>
        <label for="variation-time-range">Time Range:</label>
        <select id="variation-time-range">
          <option value="3600">1 Hour</option>
          <option value="86400">1 Day</option>
          <option value="604800">1 Week</option>
        </select>
        <button id="refresh-top-variations">Refresh</button>
      </div>
      <div id="top-variations"></div>
    </section>

    <!-- ===== SETTINGS SECTION (Theme Toggle, etc.) ===== -->
    <section id="settings-section">
      <h2>Settings</h2>
      <div id="theme-toggle-container">
        <label for="theme-select"><strong>Theme:</strong></label>
        <select id="theme-select">
          <option value="dark">Dark (Obsidian)</option>
          <option value="light">Light (Ice)</option>
        </select>
      </div>
      <p>Use this dropdown to switch between the dark ‚ÄúCrying Obsidian‚Äù theme and the light ‚ÄúIce‚Äù theme. Each section will reflect your chosen style, from cracked neon obsidian to frosted ice overlays.</p>
    </section>
  </div>

  <!-- ===== BACKGROUND MUSIC (loop, initially paused) ===== -->
  <audio id="bgMusic" src="https://cdn.pixabay.com/download/audio/2022/10/14/audio_9f8b1101b0.mp3?filename=mystic-realm-of-minecraft-235545.mp3" loop></audio>

  <!-- ====================== COMBINED JAVASCRIPT ====================== -->
  <script>
    /*********************************************************
     * 1) SIDEBAR TOGGLE & OVERLAY
     *********************************************************/
    const menuToggle = document.getElementById('menuToggle');
    const sidebar = document.getElementById('sidebar');
    const overlay = document.getElementById('overlay');
    menuToggle.addEventListener('click', () => {
      sidebar.classList.toggle('open');
      overlay.classList.toggle('show');
    });
    overlay.addEventListener('click', () => {
      sidebar.classList.remove('open');
      overlay.classList.remove('show');
    });
    document.querySelectorAll('#sidebar a').forEach(link => {
      link.addEventListener('click', () => {
        sidebar.classList.remove('open');
        overlay.classList.remove('show');
      });
    });

    /*********************************************************
     * 2) BACKGROUND MUSIC TOGGLE
     *********************************************************/
    const bgMusic = document.getElementById('bgMusic');
    const soundToggle = document.getElementById('soundToggle');
    soundToggle.addEventListener('click', () => {
      if (bgMusic.paused) {
        bgMusic.volume = 0.5;
        bgMusic.play();
        soundToggle.textContent = 'üîä';
      } else {
        bgMusic.pause();
        soundToggle.textContent = 'üîá';
      }
    });

    /*********************************************************
     * 3) THEME TOGGLE (Dark / Light)
     *********************************************************/
    const bodyEl = document.body;
    const themeSelect = document.getElementById('theme-select');
    // Default is "dark-theme"
    themeSelect.value = 'dark';
    themeSelect.addEventListener('change', () => {
      if (themeSelect.value === 'light') {
        bodyEl.classList.remove('dark-theme');
        bodyEl.classList.add('light-theme');
      } else {
        bodyEl.classList.remove('light-theme');
        bodyEl.classList.add('dark-theme');
      }
    });

    /*********************************************************
     * 4) MINECRAFT-LIKE PARTICLES (Canvas, scroll + cursor)
     *********************************************************/
    (function() {
      const container = document.getElementById('particle-container');
      if (!container) return;

      // Create a full-screen canvas
      const canvas = document.createElement('canvas');
      canvas.style.width = '100%';
      canvas.style.height = '100%';
      canvas.style.display = 'block';
      container.appendChild(canvas);

      const ctx = canvas.getContext('2d');
      let width = window.innerWidth;
      let height = window.innerHeight;
      canvas.width = width;
      canvas.height = height;

      window.addEventListener('resize', () => {
        width = window.innerWidth;
        height = window.innerHeight;
        canvas.width = width;
        canvas.height = height;
      });

      class Particle {
        constructor() {
          this.reset();
        }
        reset() {
          this.x = Math.random() * width;
          this.y = Math.random() * height;
          this.vx = (Math.random() - 0.5) * 0.4;
          this.vy = (Math.random() - 0.5) * 0.4;
          this.size = 2 + Math.random() * 3;
        }
        update() {
          this.x += this.vx;
          this.y += this.vy;
          if (this.x < 0)  this.x = width;
          if (this.x > width)  this.x = 0;
          if (this.y < 0)  this.y = height;
          if (this.y > height) this.y = 0;
        }
        draw(shiftY) {
          ctx.beginPath();
          ctx.arc(this.x, this.y + shiftY, this.size, 0, 2 * Math.PI);
          // get current theme-based color
          const themeColor = getComputedStyle(document.body).getPropertyValue('--particle-color').trim();
          ctx.fillStyle = themeColor || 'rgba(138,43,226,0.5)';
          ctx.fill();
        }
      }

      const particles = [];
      const NUM_PARTICLES = 40;
      for (let i = 0; i < NUM_PARTICLES; i++) {
        particles.push(new Particle());
      }

      let mouseX = width / 2;
      let mouseY = height / 2;
      window.addEventListener('mousemove', (e) => {
        mouseX = e.clientX;
        mouseY = e.clientY;
      });

      let scrollY = 0;
      window.addEventListener('scroll', () => {
        scrollY = window.scrollY;
      });

      function animate() {
        ctx.clearRect(0, 0, width, height);
        particles.forEach((p) => {
          p.update();
          // Repel from cursor
          const dx = p.x - mouseX;
          const dy = p.y - mouseY;
          const dist = Math.sqrt(dx*dx + dy*dy);
          if (dist < 80) {
            const angle = Math.atan2(dy, dx);
            const force = (80 - dist) / 80;
            p.x += Math.cos(angle) * force * 2;
            p.y += Math.sin(angle) * force * 2;
          }
          // Parallax shift
          const parallaxFactor = 0.05;
          p.draw(scrollY * parallaxFactor);
        });
        requestAnimationFrame(animate);
      }
      animate();
    })();

    /*********************************************************
     * 5) ORIGINAL FUNCTIONALITY (Your prior code)
     *********************************************************/
    document.addEventListener('DOMContentLoaded', () => {
      const searchInput       = document.getElementById('item-search');
      const suggestionsDiv    = document.getElementById('suggestions');
      const resultDiv         = document.getElementById('result');
      const loaderDiv         = document.getElementById('loader');
      const priceGraphCtx     = document.getElementById('priceGraph').getContext('2d');
      const topMarginsDiv     = document.getElementById('top-margins');
      const profitabilityRes  = document.getElementById('profitability-result');
      const calcProfitButton  = document.getElementById('calculate-profit');
      const topVariationsDiv  = document.getElementById('top-variations');
      const refreshTopVarBtn  = document.getElementById('refresh-top-variations');
      const variationTimeSel  = document.getElementById('variation-time-range');
      let currentItem = '';
      let chart; // store Chart.js instance

      function showLoader(show) {
        loaderDiv.style.display = show ? 'block' : 'none';
      }

      /***********************
       * AUTOCOMPLETE LOGIC
       ***********************/
      async function fetchSuggestions(query) {
        try {
          const response = await fetch(`/autocomplete?query=${encodeURIComponent(query)}`);
          if (!response.ok) throw new Error('Failed to fetch suggestions.');
          const items = await response.json();
          suggestionsDiv.innerHTML = '';
          items.forEach(item => {
            const suggestion = document.createElement('div');
            suggestion.textContent = item;
            suggestion.addEventListener('click', () => {
              searchInput.value = item;
              suggestionsDiv.innerHTML = '';
            });
            suggestionsDiv.appendChild(suggestion);
          });
        } catch (error) {
          console.error('Autocomplete error:', error);
        }
      }
      searchInput.addEventListener('input', () => {
        const query = searchInput.value.trim();
        if (query.length < 2) {
          suggestionsDiv.innerHTML = '';
          return;
        }
        fetchSuggestions(query);
      });

      /***********************
       * FETCH GRAPH DATA
       ***********************/
      async function fetchGraphData(itemName, timeRange = 'all') {
        try {
          showLoader(true);
          const url = `/graph-data?item=${encodeURIComponent(itemName)}&range=${timeRange}`;
          const response = await fetch(url);
          if (!response.ok) throw new Error('Failed to fetch graph data.');
          const history = await response.json();
          const labels = history.map(h => new Date(h.timestamp * 1000).toLocaleTimeString());
          const buyPrices = history.map(h => h.buy_price);
          const sellPrices = history.map(h => h.sell_price);

          if (chart) chart.destroy();
          chart = new Chart(priceGraphCtx, {
            type: 'line',
            data: {
              labels,
              datasets: [
                {
                  label: 'Buy Price',
                  data: buyPrices,
                  borderColor: '#00ccff',
                  fill: false,
                  tension: 0.3
                },
                {
                  label: 'Sell Price',
                  data: sellPrices,
                  borderColor: '#ff5733',
                  fill: false,
                  tension: 0.3
                }
              ]
            },
            options: {
              plugins: {
                tooltip: {
                  callbacks: {
                    label: ctx => `${ctx.dataset.label}: ${ctx.raw.toFixed(2)}`
                  }
                },
                legend: {
                  labels: {
                    color: '#fff'
                  }
                }
              },
              scales: {
                x: {
                  ticks: { color: '#fff' },
                  grid: { color: '#555' }
                },
                y: {
                  ticks: { color: '#fff' },
                  grid: { color: '#555' }
                }
              }
            }
          });
        } catch (error) {
          console.error('Graph error:', error);
          resultDiv.innerHTML = '<p>Error loading graph data. Please try again later.</p>';
        } finally {
          showLoader(false);
        }
      }

      /***********************
       * FETCH TOP MARGINS
       ***********************/
      async function fetchTopMargins() {
        const sortBy = document.getElementById('sort-by').value;
        const order  = document.getElementById('order').value;
        try {
          showLoader(true);
          const response = await fetch(`/top-margins?sort_by=${sortBy}&order=${order}`);
          if (!response.ok) throw new Error('Failed to fetch top margins.');
          const items = await response.json();
          topMarginsDiv.innerHTML = items.map(item => `
            <div class="item-card">
              <p><span>Item:</span> ${item.item_id}</p>
              <p><span>Margin:</span> ${item.margin}</p>
              <p><span>Buy Price:</span> ${item.buy_price}</p>
              <p><span>Sell Price:</span> ${item.sell_price}</p>
              <p><span>Demand:</span> ${item.demand ?? 'N/A'}</p>
              <p><span>Supply:</span> ${item.supply ?? 'N/A'}</p>
            </div>
          `).join('');
        } catch (error) {
          console.error('Top margins error:', error);
          topMarginsDiv.innerHTML = '<p>Error loading top items. Please try again later.</p>';
        } finally {
          showLoader(false);
        }
      }

      /****************************
       * SEARCH -> FETCH ITEM DETAILS
       ****************************/
      document.getElementById('search-form').addEventListener('submit', async (e) => {
        e.preventDefault();
        const itemName = searchInput.value.trim();
        if (!itemName) return;
        currentItem = itemName;
        try {
          showLoader(true);
          const response = await fetch(`/search?item=${encodeURIComponent(itemName)}`);
          if (!response.ok) throw new Error('Failed to fetch item details.');
          const data = await response.json();
          resultDiv.innerHTML = `
            <p><strong>Item:</strong> ${data.item_id}</p>
            <p><strong>Buy Price:</strong> ${data.buy_price ?? 'N/A'}</p>
            <p><strong>Sell Price:</strong> ${data.sell_price ?? 'N/A'}</p>
            <p><strong>Margin:</strong> ${data.margin ?? 'N/A'}</p>
            <p><strong>Demand:</strong> ${data.demand ?? 'N/A'}</p>
            <p><strong>Supply:</strong> ${data.supply ?? 'N/A'}</p>
          `;
          fetchGraphData(itemName);
        } catch (error) {
          console.error('Item details error:', error);
          resultDiv.innerHTML = '<p>Error loading item details. Please try again later.</p>';
        } finally {
          showLoader(false);
        }
      });

      /****************************
       * PROFITABILITY CALCULATION
       ****************************/
      calcProfitButton.addEventListener('click', async () => {
        const coins = parseFloat(document.getElementById('coins').value);
        const difficulty = parseFloat(document.getElementById('difficulty').value);
        try {
          showLoader(true);
          const response = await fetch(`/profitability?coins=${coins}&difficulty=${difficulty}`);
          if (!response.ok) throw new Error('Failed to fetch profitability.');
          const results = await response.json();
          profitabilityRes.innerHTML = results.map(r => `
            <div class="item-card">
              <p><strong>Item:</strong> ${r.item_id}</p>
              <p><strong>Profit per Minute:</strong> ${r.profit_per_minute.toFixed(2)}</p>
              <p><strong>Profit per Hour:</strong> ${r.profit_per_hour.toFixed(2)}</p>
            </div>
          `).join('');
        } catch (error) {
          console.error('Profitability error:', error);
          profitabilityRes.innerHTML = '<p>Error calculating profitability. Please try again later.</p>';
        } finally {
          showLoader(false);
        }
      });

      /****************************
       * GRAPH TIME RANGE BUTTONS
       ****************************/
      document.querySelectorAll('.time-range-btn').forEach(btn => {
        btn.addEventListener('click', function() {
          const timeRange = this.getAttribute('data-range');
          if (currentItem) {
            fetchGraphData(currentItem, timeRange);
          }
        });
      });

      /****************************
       * TOP MARGINS REFRESH
       ****************************/
      document.getElementById('refresh-top-margins').addEventListener('click', fetchTopMargins);
      setInterval(fetchTopMargins, 60000); 
      fetchTopMargins();

      /****************************
       * TOP VARIATIONS
       ****************************/
      async function fetchTopVariations() {
        const timeRange = variationTimeSel.value;
        try {
          showLoader(true);
          const response = await fetch(`/top-variations?time_range=${timeRange}`);
          if (!response.ok) throw new Error("Failed to fetch top variations.");
          const items = await response.json();
          topVariationsDiv.innerHTML = items.map(item => `
            <div class="item-card">
              <p><span>Item:</span> ${item.item_id}</p>
              <p><span>Buy Price Change:</span> ${item.buy_price_change}%</p>
              <p><span>Sell Price Change:</span> ${item.sell_price_change}%</p>
              <p><span>Median Buy Price:</span> ${item.median_buy_price}</p>
              <p><span>Median Sell Price:</span> ${item.median_sell_price}</p>
            </div>
          `).join('');
        } catch (error) {
          console.error('Top variations error:', error);
          topVariationsDiv.innerHTML = '<p>Error loading top variations. Please try again later.</p>';
        } finally {
          showLoader(false);
        }
      }
      refreshTopVarBtn.addEventListener('click', fetchTopVariations);
      fetchTopVariations();
    });
  </script>
</body>
</html>
